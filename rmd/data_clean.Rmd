---
title: "Data cleaning"
author: "Sitian Zhou, Pei Tian"
date: "`r Sys.Date()`"
output: html_document
---
```{r setup, include=F}
knitr::opts_chunk$set(message = F, warning = F)
```

**Delivering dataset preprocessing to ensure the feasibility of merging different datasets for downstream analysis.**

```{r lib-import}
library(tidyverse)
library(rvest)
library(httr)
library(readxl)
library(janitor)
library(fuzzyjoin)
```

## Country code

Changed some country names so they match the country name in the billionaire dataset.

```{r country-code}
country_code <-
  read_csv("../data/raw/country_code.csv") |> 
  clean_names() |> 
  rename(
    "country_name" = "english_short_name_lower_case"
  ) |> 
  mutate(
    country_name = recode(country_name, 
                          "United States Of America" = "United States",
                          "Virgin Islands, British" = "British Virgin Islands",
                          "Korea, Republic of (South Korea)" = "South Korea",
                          "Virgin Islands, U.S." = "U.S. Virgin Islands",
                          "Tanzania, United Republic of" = "Tanzania",
                          "Turks and Caicos" = "Turks and Caicos Islands",
                          "Macao" = "Macau")) |> 
  select(country_name, alpha_3_code)


```


### Billionaires 2013-2023

* Filtering for data from 2013 to 2023
* Converting `net_worth` to numerical value
* Variables selection
* Merging with `country_code` dataset for further analysis

```{r recent-ten-years-billionaires}
bil_2013_2023 <-
  read_csv("../data/raw/billionaires_1997_2023.csv") |> 
  filter(year >= 2013)

bil_2013_2023_clean <-
  bil_2013_2023 |> 
  mutate(
    net_worth = str_replace_all(net_worth, " B", ""),
    net_worth = as.numeric(net_worth), 
    industries = str_replace_all(business_industries, "[\\['\\]]", ""),
    country_of_residence = 
      recode(country_of_residence, 
             "Eswatini (Swaziland)" = "Swaziland",
             "Scotland" = "United Kingdom",
             "Czechia" = "Czech Republic"),
    industries = 
      recode(industries,
             "Fashion and Retail" = "Fashion & Retail",
             "Finance and Investments" = "Finance & Investments",
             "Food and Beverage" = "Food & Beverage",
             "Healthcare" = "Health care",
             "Media" = "Media & Entertainment")) |> 
  left_join(country_code, c("country_of_residence" = "country_name")) |> 
  select(-c(month, rank, last_name, first_name, birth_date, business_category,
            business_industries, organization_name, position_in_organization))

```


### Billionaires 2023

* Changing the unit of `final_worth` to billion; result column as `net_worth`
* Cleaning `gdp_country`; changed the unit to trillion
* Recording `gender`
* Variables selection

```{r 2023-billionaires}
bil_gdp_2023 <-
  read_csv("../data/raw/billionaires_2023.csv")

bil_gdp_2023_clean <-
  bil_gdp_2023 |> 
  clean_names() |> 
  mutate(
    net_worth = final_worth / 1000,
    gdp_country = str_replace_all(gdp_country, "[$,]", ""),
    gdp_country = as.numeric(gdp_country) / 1e12,
    gender = 
      case_match(
        gender,
        "F" ~ "Female",
        "M" ~ "Male")) |>
  select(net_worth, full_name = person_name, age, gender, 
         country_of_citizenship, country_of_residence = country, 
         city_of_residence = city, industries, cpi_country, 
         cpi_change_country, gdp_country, life_expectancy_country, 
         latitude_country, longitude_country)

```

## Region-level GDP 

### Basic cleaning

* Filtering for data starts from 2013
* Changing the unit of gdp to trillion

```{r country-gdp-data}
country_gdp <-
  read_csv("../data/raw/country_gdp.csv")

country_gdp_clean <-
  country_gdp |> 
  filter(year >= 2013) |> 
  mutate(gdp = value / 1e12,
         name = country_name, 
         code = country_code) |> 
  select(name, code, year, gdp)
  
```

### Supplementary dataset
Given the issue that `Hong Kong`, `Macau` and `Taiwan` are regions with missing GDP data in raw dataset. We use some supplementary dataset to remedy it.

#### Hong Kong & Macau
```{r sar-gdp-data}
world_gdp = read_csv("../data/raw/gdp_worldbank.csv", skip = 4) |>
  janitor::clean_names()
sar_gdp = world_gdp |>
  filter(country_name == "Macao SAR, China" | country_name == "Hong Kong SAR, China") |>
  select(country_name, country_code, starts_with("x")) |>
  pivot_longer(cols = starts_with("x"), names_to = "year", names_prefix = "x", values_to = "value") |>
  mutate(gdp = value/1e12, 
         year = as.numeric(year),
         name = country_name, 
         code = country_code) |>
  filter(year >= 2013) |>
  select(name, code, year, gdp)
```

#### Taiwan
* Scapping GDP data from specific website
* Extracting and filtering GDP data
```{r tw-gdp-data}
fetch_tw_gdp = function(){
  url = "https://countryeconomy.com/gdp/taiwan"
  tw_gdp_html = read_html(url)
  mydata <- tw_gdp_html|> html_table()
  return(mydata[[1]])
}

extract_gdp = function(string){
  str_vec = str_extract(string, "\\d*,\\d*") |> 
    str_split(",") |> 
    nth(1)
  s = ""
  for(e in str_vec){
    s = str_c(s, e)
  }
  return(s)
}

tw_gdp = fetch_tw_gdp() |>
  janitor::clean_names() |>
  mutate(gdp = map(annual_gdp_2, extract_gdp) |> as.numeric(),
         year = date |> as.numeric(), 
         name = "Taiwan, China",
         code = "TWN",
         gdp = gdp/1e3) |>
  filter(year >= 2013) |>
  select(name, code, year, gdp)
```

### Merge GDP data
Combine GDP data in Hong Kong, Macau, Taiwan.
```{r merge-region-gdp}
country_gdp_clean = bind_rows(country_gdp_clean, sar_gdp, tw_gdp)
```

### Merge GDP & billionaire
Join dataset for billionaires 2013-2023 country GDP info

some problems:
* Hong Kong, Taiwan, Macau: missing GDP data (*fixed with supplementary data*)
* missing GDP data for 2023 - GDP in `bil_gdp_2023_clean` inaccurate (*use data before 2023*)

```{r merge-2}
bil_gdp_2013_2023 <-
  left_join(bil_2013_2023_clean, country_gdp_clean, by = join_by(alpha_3_code == code, year == year), multiple = "all") |>
  mutate(region_gdp = gdp, region_code = alpha_3_code) |>
  select(-c(gdp, alpha_3_code, name))
```


## Industry-level GDP for US

### Basic cleaning
* Renaming variable names
* Tidying data

```{r import-industry-data}
indus_gdp <-
  read_excel("../data/raw/usa_industry_gdp.xlsx", sheet = 18, skip = 4)

indus_gdp_clean <-
  indus_gdp |> 
  slice(3:30) |> 
  rename(
    "industries" = "...2",
    "2017" = "...3",
    "2018" = "...4",
    "2019" = "...5",
    "2020" = "...6",
    "2021" = "...7",
    "2022" = "2020...8") |>
  filter(!(industries %in% c("Finance, insurance, real estate, rental, and leasing",
                            "Educational services, health care, and social assistance",
                      "Arts, entertainment, recreation, accommodation, and food services"))) |> 
  select(industries, `2017`:`2022`) |> 
  pivot_longer(`2017`:`2022`, names_to = "year", values_to = "industry_gdp") |> 
  mutate(year = as.numeric(year))
```

### Merge industry-level GDP & billionaire

* Create two summary tables with industry names
* Use regex to match the two dataset

```{r reg-match-industry}
# extract key words to merge two datasets by industries variable
#
# industry names from industry_gdp_clean
df1 <- indus_gdp_clean |> select(industries) |> unique()
# industry names from bil_2013_2023_clean
df2 <- bil_2013_2023_clean |> select(industries) |> drop_na() |> 
  unique() |> 
  mutate(
    categories = industries,
    # rename some industries for better match results
    categories = recode(categories, 
                        "Technology" = "Information",
                        "Politics" = "State and local",
                        "Logistics" = "Transportation and warehousing",
                        "Medicine" = "Health care")) |> 
  # extract keywords for each industry
  separate(categories, into = c("word1", "word2"), sep = " & ") |> 
  pivot_longer(
    word1:word2,
    names_to = "order",
    values_to = "keywords"
  ) |> 
  drop_na(keywords)

# use regex to perform inexact matching
reg_match <-
  regex_inner_join(df1, df2, by=c("industries" = "keywords"), ignore_case = TRUE) |> 
  distinct(industries.y, .keep_all = TRUE) |>
  # removed service industry bc it's too general
  filter(industries.y != "Service") |> 
  select(industries.x, industries.y)
```


## Final dataset

Merging 3 datasets:

- Billionaire

- Region-level GDP

- Industry-level GDP

```{r merge-all-datasets}
bil_gdp_indus_2013_2023 <-
  bil_gdp_2013_2023 |> 
  left_join(reg_match, c("industries" = "industries.y")) |> 
  left_join(indus_gdp_clean, c("industries.x" = "industries", "year" = "year")) |> 
  select(-industries.x)
```

```{r save-data}
### save useful files & add some description
```

## Description for tidy data
Describe dataset saved for downstream analysis.
